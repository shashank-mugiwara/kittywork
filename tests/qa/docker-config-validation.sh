#!/bin/bash\n#\n# QA Test Suite: Docker Configuration Validation\n# Sub-issue: M5.4 - Create Docker configuration and deployment documentation\n#\n# This script validates:\n# 1. Dockerfile syntax and structure\n# 2. docker-compose.yml validity\n# 3. Environment file completeness\n# 4. Documentation coverage\n#\n\nset -e\n\necho \"=====================================================================\"\necho \"QA TEST SUITE: M5.4 Docker Configuration Validation\"\necho \"=====================================================================\"\necho \"\"\n\n# Test Counter\nTESTS_RUN=0\nTESTS_PASSED=0\nTESTS_FAILED=0\n\n# Test helper function\nrun_test() {\n    local test_name=\"$1\"\n    local test_command=\"$2\"\n    local expected_result=\"${3:-0}\"\n    \n    TESTS_RUN=$((TESTS_RUN + 1))\n    \n    echo -n \"[TEST $TESTS_RUN] $test_name... \"\n    \n    if eval \"$test_command\" > /dev/null 2>&1; then\n        echo \"âœ“ PASSED\"\n        TESTS_PASSED=$((TESTS_PASSED + 1))\n    else\n        echo \"âœ— FAILED\"\n        TESTS_FAILED=$((TESTS_FAILED + 1))\n    fi\n}\n\necho \"=== SECTION 1: Dockerfile Validation ===\"\necho \"\"\n\n# 1.1 Dockerfile exists\nrun_test \"Dockerfile exists\" \"[ -f Dockerfile ]\"\n\n# 1.2 Dockerfile contains multi-stage build\nrun_test \"Dockerfile has multi-stage build (FROM ... AS builder)\" \"grep -q 'FROM.*AS builder' Dockerfile\"\n\n# 1.3 Dockerfile specifies Java 25\nrun_test \"Dockerfile uses Java 25 (eclipse-temurin:25)\" \"grep -q 'eclipse-temurin:25' Dockerfile\"\n\n# 1.4 Dockerfile has chiseled runtime image\nrun_test \"Dockerfile uses chiseled JRE (jre-noble-chiseled)\" \"grep -q 'jre-noble-chiseled' Dockerfile\"\n\n# 1.5 Dockerfile creates non-root user\nrun_test \"Dockerfile creates non-root user (appuser)\" \"grep -q 'adduser.*appuser' Dockerfile\"\n\n# 1.6 Dockerfile sets USER appuser\nrun_test \"Dockerfile switches to non-root user\" \"grep -q '^USER appuser' Dockerfile\"\n\n# 1.7 Dockerfile exposes port 8080\nrun_test \"Dockerfile exposes port 8080\" \"grep -q 'EXPOSE 8080' Dockerfile\"\n\n# 1.8 Dockerfile has health check\nrun_test \"Dockerfile defines HEALTHCHECK\" \"grep -q 'HEALTHCHECK' Dockerfile\"\n\n# 1.9 Dockerfile uses wget for health check (not curl)\nrun_test \"Health check uses wget (chiseled JRE compatible)\" \"grep -q 'wget.*actuator/health' Dockerfile\"\n\n# 1.10 Dockerfile sets JAVA_OPTS environment variable\nrun_test \"Dockerfile sets JAVA_OPTS environment variable\" \"grep -q 'ENV JAVA_OPTS' Dockerfile\"\n\n# 1.11 Dockerfile uses CMD (not ENTRYPOINT) for variable expansion\nrun_test \"Dockerfile uses CMD with shell expansion (sh -c)\" \"grep -q 'CMD.*sh.*-c' Dockerfile\"\n\n# 1.12 Dockerfile has LABEL metadata\nrun_test \"Dockerfile includes LABEL metadata\" \"grep -q 'LABEL' Dockerfile\"\n\necho \"\"\necho \"=== SECTION 2: docker-compose.yml Validation ===\"\necho \"\"\n\n# 2.1 docker-compose.yml exists\nrun_test \"docker-compose.yml exists\" \"[ -f docker-compose.yml ]\"\n\n# 2.2 docker-compose.yml has correct version\nrun_test \"docker-compose.yml version is 3.8+\" \"grep -q 'version.*3\\.[8-9]' docker-compose.yml\"\n\n# 2.3 docker-compose.yml defines postgres service\nrun_test \"docker-compose.yml defines postgres service\" \"grep -q 'postgres:' docker-compose.yml\"\n\n# 2.4 docker-compose.yml defines app service\nrun_test \"docker-compose.yml defines app service\" \"grep -q 'app:' docker-compose.yml\"\n\n# 2.5 PostgreSQL service uses Alpine image\nrun_test \"PostgreSQL service uses postgres:16-alpine\" \"grep -q 'postgres:16-alpine' docker-compose.yml\"\n\n# 2.6 Services have health checks\nrun_test \"Services define healthcheck blocks\" \"grep -c 'healthcheck:' docker-compose.yml | grep -q -E '[2-9]|1[0-9]'\"\n\n# 2.7 PostgreSQL has health check\nrun_test \"PostgreSQL has health check (pg_isready)\" \"grep -q 'pg_isready' docker-compose.yml\"\n\n# 2.8 App service depends on postgres\nrun_test \"App service depends_on postgres with condition service_healthy\" \"grep -A 2 'depends_on:' docker-compose.yml | grep -q 'service_healthy'\"\n\n# 2.9 docker-compose.yml defines volumes\nrun_test \"docker-compose.yml defines volumes section\" \"grep -q '^volumes:' docker-compose.yml\"\n\n# 2.10 docker-compose.yml defines networks\nrun_test \"docker-compose.yml defines networks section\" \"grep -q '^networks:' docker-compose.yml\"\n\n# 2.11 docker-compose.yml uses bridge network\nrun_test \"docker-compose.yml uses bridge network\" \"grep -q 'driver: bridge' docker-compose.yml\"\n\n# 2.12 App service has restart policy\nrun_test \"App service has restart policy\" \"grep -A 20 'app:' docker-compose.yml | grep -q 'restart:'\"\n\n# 2.13 PostgreSQL service has restart policy\nrun_test \"PostgreSQL service has restart policy\" \"grep -A 20 'postgres:' docker-compose.yml | grep -q 'restart:'\"\n\n# 2.14 Logging driver configured\nrun_test \"App service has json-file logging driver\" \"grep -q 'json-file' docker-compose.yml\"\n\n# 2.15 Environment variables passed to services\nrun_test \"Services receive environment variables\" \"grep -c 'environment:' docker-compose.yml | grep -q -E '[2-9]|1[0-9]'\"\n\n# 2.16 docker-compose.yml uses environment variable substitution\nrun_test \"docker-compose.yml uses \\${} variable substitution\" \"grep -q '\\${' docker-compose.yml\"\n\necho \"\"\necho \"=== SECTION 3: Environment File Validation ===\"\necho \"\"\n\n# 3.1 .env.example exists\nrun_test \".env.example file exists\" \"[ -f .env.example ]\"\n\n# 3.2 .env.example has database configuration\nrun_test \".env.example has DB_HOST\" \"grep -q 'DB_HOST' .env.example\"\nrun_test \".env.example has DB_PORT\" \"grep -q 'DB_PORT' .env.example\"\nrun_test \".env.example has DB_NAME\" \"grep -q 'DB_NAME' .env.example\"\nrun_test \".env.example has DB_USER\" \"grep -q 'DB_USER' .env.example\"\nrun_test \".env.example has DB_PASSWORD\" \"grep -q 'DB_PASSWORD' .env.example\"\n\n# 3.3 .env.example has AWS S3 configuration\nrun_test \".env.example has AWS_S3_BUCKET\" \"grep -q 'AWS_S3_BUCKET' .env.example\"\nrun_test \".env.example has AWS_S3_REGION\" \"grep -q 'AWS_S3_REGION' .env.example\"\nrun_test \".env.example has AWS_ACCESS_KEY_ID\" \"grep -q 'AWS_ACCESS_KEY_ID' .env.example\"\nrun_test \".env.example has AWS_SECRET_ACCESS_KEY\" \"grep -q 'AWS_SECRET_ACCESS_KEY' .env.example\"\n\n# 3.4 .env.example has Spring Boot configuration\nrun_test \".env.example has SPRING_PROFILES_ACTIVE\" \"grep -q 'SPRING_PROFILES_ACTIVE' .env.example\"\nrun_test \".env.example has APP_PORT\" \"grep -q 'APP_PORT' .env.example\"\nrun_test \".env.example has LOGGING_LEVEL_ROOT\" \"grep -q 'LOGGING_LEVEL_ROOT' .env.example\"\n\n# 3.5 .env.example has JVM configuration\nrun_test \".env.example has JAVA_OPTS\" \"grep -q 'JAVA_OPTS' .env.example\"\n\n# 3.6 .env.example has feature flags\nrun_test \".env.example has FEATURE_S3_ENABLED\" \"grep -q 'FEATURE_S3_ENABLED' .env.example\"\nrun_test \".env.example has FILE_UPLOAD_MAX_SIZE\" \"grep -q 'FILE_UPLOAD_MAX_SIZE' .env.example\"\nrun_test \".env.example has FILE_UPLOAD_ALLOWED_TYPES\" \"grep -q 'FILE_UPLOAD_ALLOWED_TYPES' .env.example\"\n\n# 3.7 .env.example has documentation comments\nrun_test \".env.example has section headers with #\" \"grep -c '^#.*====' .env.example | grep -q -E '[3-9]|1[0-9]'\"\n\n# 3.8 .env.example has security warnings\nrun_test \".env.example includes security warnings\" \"grep -i 'security\\|never commit\\|credentials' .env.example\"\n\necho \"\"\necho \"=== SECTION 4: Docker Build Configuration ===\"\necho \"\"\n\n# 4.1 .dockerignore exists\nrun_test \".dockerignore file exists\" \"[ -f .dockerignore ]\"\n\n# 4.2 .dockerignore excludes git\nrun_test \".dockerignore excludes .git\" \"grep -q '\\.git' .dockerignore\"\n\n# 4.3 .dockerignore excludes Maven artifacts\nrun_test \".dockerignore excludes Maven artifacts (target/)\" \"grep -q 'target' .dockerignore\"\n\n# 4.4 .dockerignore excludes IDE files\nrun_test \".dockerignore excludes IDE files\" \"grep -qE '\\.idea|\\.vscode' .dockerignore\"\n\n# 4.5 .dockerignore excludes node_modules if applicable\nrun_test \".dockerignore excludes common build artifacts\" \"grep -c '^[^#]*' .dockerignore | grep -q -E '[5-9]|1[0-9]'\"\n\necho \"\"\necho \"=== SECTION 5: Docker Helper Scripts ===\"\necho \"\"\n\n# 5.1 docker/init-db.sql exists\nrun_test \"docker/init-db.sql initialization script exists\" \"[ -f docker/init-db.sql ]\"\n\n# 5.2 docker/DOCKER_REFERENCE.md exists\nrun_test \"docker/DOCKER_REFERENCE.md reference guide exists\" \"[ -f docker/DOCKER_REFERENCE.md ]\"\n\n# 5.3 docker/init-db.sql has SQL syntax\nrun_test \"docker/init-db.sql contains SQL comments\" \"grep -q '^--' docker/init-db.sql\"\n\necho \"\"\necho \"=== SECTION 6: Documentation Validation ===\"\necho \"\"\n\n# 6.1 DEPLOYMENT.md exists\nrun_test \"DEPLOYMENT.md documentation exists\" \"[ -f DEPLOYMENT.md ]\"\n\n# 6.2 DEPLOYMENT.md is substantial (>500 lines)\nrun_test \"DEPLOYMENT.md has substantial content (500+ lines)\" \"[ $(wc -l < DEPLOYMENT.md) -gt 500 ]\"\n\n# 6.3 DEPLOYMENT.md has table of contents\nrun_test \"DEPLOYMENT.md includes Table of Contents\" \"grep -q '## Table of Contents\\|## Contents' DEPLOYMENT.md\"\n\n# 6.4 DEPLOYMENT.md has Prerequisites section\nrun_test \"DEPLOYMENT.md has Prerequisites section\" \"grep -q '## Prerequisites' DEPLOYMENT.md\"\n\n# 6.5 DEPLOYMENT.md has Quick Start section\nrun_test \"DEPLOYMENT.md has Quick Start section\" \"grep -q 'Quick Start\\|quick start' DEPLOYMENT.md\"\n\n# 6.6 DEPLOYMENT.md has Environment Configuration\nrun_test \"DEPLOYMENT.md has Environment Configuration\" \"grep -q 'Environment Configuration' DEPLOYMENT.md\"\n\n# 6.7 DEPLOYMENT.md has Health Checks section\nrun_test \"DEPLOYMENT.md has Health Checks section\" \"grep -q 'Health Check' DEPLOYMENT.md\"\n\n# 6.8 DEPLOYMENT.md has Database Migrations section\nrun_test \"DEPLOYMENT.md has Database Migrations section\" \"grep -q 'Database Migrations\\|Migration' DEPLOYMENT.md\"\n\n# 6.9 DEPLOYMENT.md has S3 Integration section\nrun_test \"DEPLOYMENT.md has AWS S3 Integration section\" \"grep -q 'S3 Integration\\|AWS S3' DEPLOYMENT.md\"\n\n# 6.10 DEPLOYMENT.md has Troubleshooting section\nrun_test \"DEPLOYMENT.md has Troubleshooting section\" \"grep -q 'Troubleshooting\\|## Trouble' DEPLOYMENT.md\"\n\n# 6.11 DEPLOYMENT.md includes code examples\nrun_test \"DEPLOYMENT.md includes bash code examples\" \"grep -c '\\`\\`\\`bash' DEPLOYMENT.md | grep -q -E '[3-9]|[1-9][0-9]'\"\n\n# 6.12 DEPLOYMENT.md includes configuration examples\nrun_test \"DEPLOYMENT.md includes configuration examples\" \"grep -c '\\`\\`\\`' DEPLOYMENT.md | grep -q -E '[5-9]|[1-9][0-9]'\"\n\n# 6.13 DEPLOYMENT.md has Kubernetes deployment example\nrun_test \"DEPLOYMENT.md includes Kubernetes deployment example\" \"grep -q 'Kubernetes\\|apiVersion:' DEPLOYMENT.md\"\n\n# 6.14 DEPLOYMENT.md has Nginx configuration example\nrun_test \"DEPLOYMENT.md includes Nginx reverse proxy example\" \"grep -q 'nginx\\|Nginx' DEPLOYMENT.md\"\n\necho \"\"\necho \"=== SECTION 7: Security Validation ===\"\necho \"\"\n\n# 7.1 No hardcoded credentials in Dockerfile\nrun_test \"Dockerfile has no hardcoded passwords\" \"! grep -qE 'password|secret|key' Dockerfile | head -1\"\n\n# 7.2 No hardcoded credentials in docker-compose.yml example\nrun_test \"docker-compose.yml uses environment variable substitution (no hardcoded secrets)\" \"grep -q '\\${' docker-compose.yml\"\n\n# 7.3 .env.example warns about security\nrun_test \".env.example has security warnings about .env in git\" \"grep -i 'commit.*git\\|never commit' .env.example\"\n\n# 7.5 DEPLOYMENT.md mentions security best practices\nrun_test \"DEPLOYMENT.md mentions security best practices\" \"grep -q -i 'security\\|secret' DEPLOYMENT.md\"\n\n# 7.6 DEPLOYMENT.md mentions IAM roles for production\nrun_test \"DEPLOYMENT.md mentions IAM roles (not hardcoded credentials)\" \"grep -q 'IAM role' DEPLOYMENT.md\"\n\necho \"\"\necho \"=== SECTION 8: Container Configuration Validation ===\"\necho \"\"\n\n# 8.1 Health check has reasonable interval\nrun_test \"Dockerfile health check interval is configured\" \"grep -q 'interval=' Dockerfile\"\n\n# 8.2 Health check has timeout\nrun_test \"Dockerfile health check has timeout\" \"grep -q 'timeout=' Dockerfile\"\n\n# 8.3 Health check has retries\nrun_test \"Dockerfile health check has retry count\" \"grep -q 'retries=' Dockerfile\"\n\n# 8.4 Health check has start period\nrun_test \"Dockerfile health check has start period\" \"grep -q 'start-period=' Dockerfile\"\n\n# 8.5 JVM GC configured for containers\nrun_test \"JAVA_OPTS includes G1GC for containers\" \"grep -q 'UseG1GC' Dockerfile\"\n\n# 8.6 JVM has memory limits\nrun_test \"JAVA_OPTS specifies Xmx (heap memory limit)\" \"grep -q 'Xmx' Dockerfile\"\n\necho \"\"\necho \"=====================================================================\"\necho \"TEST RESULTS SUMMARY\"\necho \"=====================================================================\"\necho \"\"\necho \"Total Tests Run:     $TESTS_RUN\"\necho \"Tests Passed:        $TESTS_PASSED âœ“\"\necho \"Tests Failed:        $TESTS_FAILED âœ—\"\necho \"\"\n\nif [ $TESTS_FAILED -eq 0 ]; then\n    echo \"ðŸŽ‰ ALL TESTS PASSED! âœ“\"\n    echo \"\"\n    echo \"M5.4 Docker Configuration and Deployment Documentation QA Status: APPROVED\"\n    exit 0\nelse\n    echo \"âŒ SOME TESTS FAILED\"\n    echo \"\"\n    echo \"Please review the failed tests above and update configuration files accordingly.\"\n    exit 1\nfi\n